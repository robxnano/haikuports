SUMMARY="A tool to convert video from nearly any format to modern codecs"
DESCRIPTION="HandBrake is an open-source, GPL-licensed, multiplatform, \
multithreaded video transcoder.
Convert from many common multimedia file formats, including unprotected \
DVD or Blu-ray sources to a handful of modern output file formats."
HOMEPAGE="https://handbrake.fr/"
LICENSE="GNU GPL v2"
COPYRIGHT="2003-2023 HandBrake Team"
REVISION="9"
SOURCE_URI="https://github.com/HandBrake/HandBrake/releases/download/$portVersion/HandBrake-$portVersion-source.tar.bz2"
CHECKSUM_SHA256="3999fe06d5309c819799a73a968a8ec3840e7840c2b64af8f5cdb7fd8c9430f0"
SOURCE_DIR="HandBrake-$portVersion"
PATCHES="handbrake-$portVersion.patchset"
ADDITIONAL_FILES="HandBrake.rdef"

ARCHITECTURES="all !x86_gcc2"
SECONDARY_ARCHITECTURES="x86"

PROVIDES="
	handbrake$secondaryArchSuffix = $portVersion
	cmd:ghb
	cmd:HandBrakeCLI
	"
REQUIRES="
	haiku$secondaryArchSuffix
	lib:libass$secondaryArchSuffix
	lib:libatk_1.0$secondaryArchSuffix
	lib:libbz2$secondaryArchSuffix
	lib:libcairo$secondaryArchSuffix
	lib:libcairo_gobject$secondaryArchSuffix
	lib:libdbus_1$secondaryArchSuffix
	lib:libdbus_glib_1$secondaryArchSuffix
	lib:libdvdcss$secondaryArchSuffix
	lib:libflac$secondaryArchSuffix
	lib:libfontconfig$secondaryArchSuffix
	lib:libfreetype$secondaryArchSuffix
	lib:libfribidi$secondaryArchSuffix
	lib:libgdk_pixbuf_2.0$secondaryArchSuffix
	lib:libglib_2.0$secondaryArchSuffix
	lib:libgstaudio_1.0$secondaryArchSuffix
	lib:libgstbase_1.0$secondaryArchSuffix
	lib:libgstpbutils_1.0$secondaryArchSuffix
	lib:libgsttag_1.0$secondaryArchSuffix
	lib:libgstvideo_1.0$secondaryArchSuffix
	lib:libgtk_3$secondaryArchSuffix
	lib:libharfbuzz$secondaryArchSuffix
	lib:libiconv$secondaryArchSuffix
	lib:libintl$secondaryArchSuffix
	lib:libjansson$secondaryArchSuffix
	lib:liblzma$secondaryArchSuffix
	lib:libmp3lame$secondaryArchSuffix
	lib:libnotify$secondaryArchSuffix
	lib:libogg$secondaryArchSuffix
	lib:libopus$secondaryArchSuffix
	lib:liborc_0.4$secondaryArchSuffix
	lib:libpango_1.0$secondaryArchSuffix
	lib:libsamplerate$secondaryArchSuffix
	lib:libspeex$secondaryArchSuffix
	lib:libtheora$secondaryArchSuffix
	lib:libturbojpeg$secondaryArchSuffix
	lib:libvorbis$secondaryArchSuffix
	lib:libvpx$secondaryArchSuffix
	lib:libx264$secondaryArchSuffix
	lib:libxml2$secondaryArchSuffix
	lib:libz$secondaryArchSuffix
	"

BUILD_REQUIRES="
	haiku${secondaryArchSuffix}_devel
	devel:libass$secondaryArchSuffix
	devel:libatk_1.0$secondaryArchSuffix
	devel:libbz2$secondaryArchSuffix
	devel:libcairo$secondaryArchSuffix
	devel:libcairo_gobject$secondaryArchSuffix
	devel:libdbus_1$secondaryArchSuffix
	devel:libdbus_glib_1$secondaryArchSuffix
	devel:libdvdcss$secondaryArchSuffix
	devel:libflac$secondaryArchSuffix
	devel:libfontconfig$secondaryArchSuffix
	devel:libfreetype$secondaryArchSuffix
	devel:libfribidi$secondaryArchSuffix
	devel:libgdk_pixbuf_2.0$secondaryArchSuffix
	devel:libglib_2.0$secondaryArchSuffix
	devel:libgstaudio_1.0$secondaryArchSuffix
	devel:libgstbase_1.0$secondaryArchSuffix
	devel:libgstpbutils_1.0$secondaryArchSuffix
	devel:libgsttag_1.0$secondaryArchSuffix
	devel:libgstvideo_1.0$secondaryArchSuffix
	devel:libgtk_3$secondaryArchSuffix
	devel:libharfbuzz$secondaryArchSuffix
	devel:libiconv$secondaryArchSuffix
	devel:libintl$secondaryArchSuffix
	devel:libjansson$secondaryArchSuffix
	devel:liblzma$secondaryArchSuffix
	devel:libmp3lame$secondaryArchSuffix
	devel:libnotify$secondaryArchSuffix
	devel:libogg$secondaryArchSuffix
	devel:libopus$secondaryArchSuffix
	devel:liborc_0.4$secondaryArchSuffix
	devel:libpango_1.0$secondaryArchSuffix
	devel:libsamplerate$secondaryArchSuffix
	devel:libspeex$secondaryArchSuffix
	devel:libtheora$secondaryArchSuffix
	devel:libturbojpeg$secondaryArchSuffix
	devel:libvorbis$secondaryArchSuffix
	devel:libvpx$secondaryArchSuffix
	devel:libx264$secondaryArchSuffix
	devel:libxml2$secondaryArchSuffix
	devel:libz$secondaryArchSuffix
	"
BUILD_PREREQUIRES="
	cmd:autoconf
	cmd:automake
	cmd:cmake
	cmd:gcc$secondaryArchSuffix
	cmd:gettext
	cmd:libtool
	cmd:m4
	cmd:make
	cmd:meson
	cmd:nasm$secondaryArchSuffix
	cmd:ninja$secondaryArchSuffix
	cmd:patch
	cmd:pkg_config$secondaryArchSuffix
	cmd:python2
	cmd:sed
	cmd:tar
	"

# Please check the file state.md in this directory for a detailed description
# of the current state of the HandBrake port

PATCH()
{
	INCLUDE_DIR=`finddir B_SYSTEM_DIRECTORY`/$relativeIncludeDir
	sed -i "s|/system/develop/headers|$INCLUDE_DIR|g" libhb/module.defs
	sed -i 's/i686/i586/g' make/include/gcc.defs
}

BUILD()
{
	./configure --prefix=$prefix --datadir=$dataDir --force \
	   --disable-gtk-update-checks
	cd build
	make $jobArgs
}

INSTALL()
{
	cd build
	make install
	local MAJOR="`echo "$portVersion" | cut -d. -f1`"
	local MIDDLE="`echo "$portVersion" | cut -d. -f2`"
	local MINOR="`echo "$portVersion" | cut -d. -f3`"
	sed \
		-e "s|@MAJOR@|$MAJOR|" \
		-e "s|@MIDDLE@|$MIDDLE|" \
		-e "s|@MINOR@|$MINOR|" \
		$portDir/additional-files/HandBrake.rdef > HandBrake.rdef
	addAppDeskbarSymlink $prefix/bin/ghb HandBrake
	addResourcesToBinaries HandBrake.rdef $prefix/bin/ghb
	addResourcesToBinaries HandBrake.rdef $binDir/HandBrakeCLI
}
